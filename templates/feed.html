{% extends 'base.html' %}
{% block content %}
<h2 class="text-primary">Respect Moments Feed</h2>
<form id="feed-form" method="post" class="mb-4 needs-validation" novalidate>
  <div class="row g-2">
    <div class="col-md-2">
      <input type="text" name="by" class="form-control {% if errors.by %}is-invalid{% endif %}" placeholder="Name" value="{{ form_data.by }}" required>
      {% if errors.by %}<div class="invalid-feedback">{{ errors.by }}</div>{% endif %}
    </div>
    <div class="col-md-8">
      <input type="text" name="text" class="form-control {% if errors.text %}is-invalid{% endif %}" placeholder="What's the moment?" value="{{ form_data.text }}" required>
      {% if errors.text %}<div class="invalid-feedback">{{ errors.text }}</div>{% endif %}
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100">Post</button>
    </div>
  </div>
</form>
<ul id="feed-list" class="list-group">
  {% for m in feed %}
  <li class="list-group-item feed-item">
    <span class="feed-item-header">{{ m.by }}</span>
    <span class="feed-item-time">({{ m.time }})</span>
    <p class="mb-0 mt-2">{{ m.text }}</p>
  </li>
  {% endfor %}
</ul>
<script>
  document.getElementById('feed-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var form = this;
    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      return;
    }
    var data = { by: form.by.value.trim(), text: form.text.value.trim() };
    fetch("{{ url_for('api_feed') }}", {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
    })
    .then(function(res) { return res.ok ? res.json() : Promise.reject(res); })
    .then(function(entry) {
      var li = document.createElement('li');
      li.className = 'list-group-item feed-item';
      li.innerHTML = '<span class="feed-item-header">'+entry.by+'</span>'+
                     '<span class="feed-item-time">('+entry.time+')</span>'+
                     '<p class="mb-0 mt-2">'+entry.text+'</p>';
      var ul = document.getElementById('feed-list');
      ul.insertBefore(li, ul.firstChild);
      form.reset(); form.classList.remove('was-validated');
    }).catch(function(err) { console.error('Feed post failed', err); });
  });
</script>
{% endblock %}
